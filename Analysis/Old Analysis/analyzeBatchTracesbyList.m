function analyzeBatchTracesByList()

settings = tfSettings();

comment = '';

dataName = 'EV';
dataSource = 3;

fileList = {...
 
% % ACV -2 clean tubing
%  'RTTF111229-100417.mat',...
% 'RTTF111229-135806.mat',...
% 'RTTF111229-165423.mat',...
% 'RTTF111230-092955.mat',...
% 'RTTF120103-092432.mat',...
% 'RTTF120103-102124.mat',...

% % ACV -2 clean tubing POLBS
'RTTF111229-102516.mat',...
'RTTF111229-141909.mat',...
'RTTF111229-171456.mat',...
'RTTF111230-095137.mat',...
'RTTF120103-094445.mat',...
'RTTF120103-104148.mat',...

% MeS -2 clean tubing
% 'RTTF111229-120441.mat',...
% 'RTTF111229-125807.mat',...
% 'RTTF111229-145716.mat',...
% 'RTTF111229-154523.mat',...
% 'RTTF111230-123647.mat',...
% 'RTTF120103-123654.mat',...

% % EV clean tubing
% 'RTTF111229-110259.mat',...
% 'RTTF111230-102729.mat',...
% 'RTTF111230-113611.mat',...
% 'RTTF120103-111929.mat',...
% 'RTTF120103-133957.mat',...
% 'RTTF120103-143525.mat',...


%     % SOS done
%     'RTTF111201-104428.mat',...
%     'RTTF111201-122216.mat',...
%     'RTTF111201-135624.mat',...
%     'RTTF111201-151025.mat',...
%     'RTTF111207-133608.mat',...
%     'RTTF111207-164512.mat',...
%     'RTTF111209-130706.mat',...
%     'RTTF111209-143258.mat',...
%     'RTTF111209-153722.mat',...
%     'RTTF111209-170747.mat',...
%     'RTTF111213-112413.mat',...
%     'RTTF111213-142503.mat',...
%     'RTTF111213-152740.mat',...

% % EV n=7
% 'RTTF111213-170545.mat',...
% 'RTTF111213-183819.mat',...
% 'RTTF111214-114117.mat',...
% 'RTTF111220-093507.mat',...
% 'RTTF111220-112600.mat',...
% 'RTTF111220-143202.mat',...
% 'RTTF111221-112749.mat',...

% % MeS -2 n=6
% 'RTTF111213-173620.mat',...
% 'RTTF111214-094847.mat',...
% 'RTTF111220-163143.mat',...
% 'RTTF111221-105454.mat',...
% 'RTTF111221-133916.mat',...
% 'RTTF111221-144120.mat',...

% % ETA -6 n=7
% 'RTTF111214-103813.mat',...
% 'RTTF111220-090618.mat',...
% 'RTTF111220-102128.mat',...
% 'RTTF111220-133043.mat',...
% 'RTTF111220-135957.mat',...
% 'RTTF111220-150222.mat',...
% 'RTTF111220-153111.mat',...

% % ACV -2 n=7
% 'RTTF111213-163402.mat',...
% 'RTTF111213-180751.mat',...
% 'RTTF111214-111002.mat',...
% 'RTTF111214-125233.mat',...
% 'RTTF111220-105321.mat',...
% 'RTTF111220-130052.mat',...
% 'RTTF111221-115549.mat',...

% % ACV -1 n = 3
% 'RTTF111221-140958.mat',...
% 'RTTF111221-131022.mat',...
% 'RTTF111220-160100.mat',...

% ACV 0 n = 4
% 'RTTF111213-160505.mat',...
% 'RTTF111214-121916.mat',...
% 'RTTF111220-122537.mat',...
% 'RTTF111221-123619.mat',...

% % CL stripe -> OL box
%     'RTTF111201-100350.mat',...
%     'RTTF111201-111609.mat',...
%     'RTTF111201-131413.mat',...
%     'RTTF111201-142605.mat',...
%     'RTTF111130-150114.mat',...
%     'RTTF111130-135425.mat',...
%     'RTTF111207-125402.mat',...
%     'RTTF111207-160215.mat',...
%     'RTTF111209-122706.mat',...
%     'RTTF111209-134243.mat',...
%     'RTTF111209-145648.mat',...
%     'RTTF111209-162709.mat',...
%     'RTTF111210-143748.mat',...
%     'RTTF111213-104411.mat',...
%     'RTTF111213-114631.mat',...
%     'RTTF111213-134401.mat',...
%     'RTTF111213-144541.mat',...

%     % Old SOS done
%             'RTTF100716-115659.mat', ...
%             'RTTF100716-132452.mat', ...
%             'RTTF100716-135907.mat', ...
%             'RTTF100716-155637.mat', ...
%             'RTTF100716-105943.mat', ...
%             'RTTF100716-112325.mat', ...            
%             'RTTF100715-111719.mat', ...
%             'RTTF100715-114354.mat', ...
%             'RTTF100715-134948.mat', ...
%             'RTTF100715-145655.mat', ...
    
            };



        
tOffset = -.2; % Timing offset
rateError = -.43; % Correction for DAQ clock
colorList = [[0,0,0];pretty('r');pretty('q');pretty('h');pretty('g');pretty('b');pretty('i');pretty('v');[0,0,0];pretty('r');pretty('q');pretty('h');pretty('g');pretty('b');pretty('i');pretty('v');[0,0,0];pretty('r');pretty('q');pretty('h');pretty('g');pretty('b');pretty('i');pretty('v')];



%% Get parameters from first file
    i = 1;
    fileName = fileList{i};   
    load([settings.dataDir,fileName]);
    %histogramBounds = [5,120;420,540;540,660];
    nSamples = size(data.LAmp,1);
    expTime = ((1:nSamples) ./ (daqParams.SampleRate + rateError)) + tOffset;
    numHist = size(histogramBounds,1);
    %numHist = 5;
    
    disp(['Analyzing ',num2str(size(fileList,2)),' files...']);
    
%%
 
% Generate histogram ranges
rangeX = 0:7.5:360;
range1 =-1080:3.75:1080;
range2 =-240:2:240;
rangeT = 0:1:120;
filterSamplePad = 0;

 traceFig = figure();
 histFig = figure();
 dHistFig = figure();
n = {};

histList = [1,12,13];
numHist = size(histList,2);
% Do histograms separately
for subPlotN = 1:numHist
    
    histN = histList(subPlotN);
    disp(['Hist #: ',num2str(histN)]);
%             if histN == 1
%                 rangeT = 0:1:600;
%             else
                rangeT = 0:1:120;
%             end
    n{subPlotN} = zeros(size(rangeT,2),size(rangeX,2));
    
    % Go through once to get the means
	for fileN=1:size(fileList,2)
        
        disp(['File #: ',num2str(fileN),' pass 1.']);
        
        % For each file, get the data
        fileName = fileList{fileN};
        load([settings.dataDir,fileName]);
        %histogramBounds = [5,120;420,540;540,660];
        %numHist = 5;
        epochList = nonzeros(histogramBounds(histN,:));
        numEpochs = size(epochList,1)/2;
        epochSamples = round((epochList - tOffset) .* (daqParams.SampleRate + rateError));
        % For each epoch to align
        for epoch = 1:numEpochs
            
            % Pad samples to protect against filter transients
            filtStSamp = epochSamples(2*epoch - 1) - filterSamplePad;
            stSamp = epochSamples(2*epoch - 1);
            endSamp   = epochSamples(2*epoch);
            filtEndSamp   = epochSamples(2*epoch) + filterSamplePad;
            if (filtStSamp < 1) filtStSamp = 1; end
            if (filtEndSamp > size(data.LAmp,1)) filtEndSamp = size(data.LAmp,1); end
            sampList  = filtStSamp:filtEndSamp;
            lTrace = data.LAmp(sampList);
            rTrace = data.RAmp(sampList);
            xTrace = data.X(sampList);
            [smoothX, wrappedX] = smoothUnwrap(xTrace, daqParams.xOutputCal, 0);
            time = expTime(1:size(wrappedX,2)) - expTime(1);
%             
            figure(traceFig);
            subplot(numHist,1,subPlotN); hold on;            
            plot(time,wrappedX);
            xlim([0 time(end)]);
            ylim([0 360]);
            set(gca,'YTick',[90 180 270 360]);
            
            figure(histFig);
            thisHist = hist3([time;wrappedX]',{rangeT,rangeX});
            subplot(6,numHist,(dataSource-1)*numHist + subPlotN); hold on;
            plot(rangeX,sum(thisHist,1).*size(fileList,2),'b');
            n{subPlotN} = n{subPlotN} + thisHist;
            
  
        end
    end
    
    figure(dHistFig);
    subplot(numHist,1,subPlotN); hold on;
    h = pcolor(rangeT,rangeX, (n{subPlotN})');
    set(h,'EdgeColor','none');
    ylim([0 360]);
    set(gca,'YTick',[90 180 270 360]);
    
    figure(histFig);
    subplot(6,numHist,(dataSource-1)*numHist + subPlotN); hold on;    
    sourceData = n{subPlotN};
    for Xn = 1:size(rangeX,2)
        counts(Xn) = sum(sourceData(:,Xn));
    end
    plot(rangeX,counts,'Color','r','LineWidth',2);
    xlim([0,360]);
    set(gca,'XTick',[90 180 270 360]);
    set(gca,'YTick',[]);
end

subplot(6,numHist,(dataSource-1)*numHist + 1);
ylabel(dataName);

    
        
        
   